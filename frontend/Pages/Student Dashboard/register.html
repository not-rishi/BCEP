<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BCEP | Event Info</title>
    <link rel="icon" type="image/png" href="../../Data/Images/logo.png" />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="register.css" />
    <link rel="stylesheet" href="../../Loader/loader.css" />
    <style>
      .register-btn.unregister {
        background: linear-gradient(45deg, #ff4d4d, #cc0000);
        border: 1px solid #ff3333;
        color: white;
      }
      .register-btn.unregister:hover {
        background: linear-gradient(45deg, #cc0000, #990000);
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
      }
    </style>
  </head>
  <body>
    <div id="loader-wrapper">
      <img id="loader-logo" src="../../Data/Images/logo.png" alt="Logo" />
      <div class="progress-container"><div class="progress-bar"></div></div>
    </div>
    <script src="../../Loader/loader.js"></script>
    <script src="../../config.js"></script>
    <div id="vanta-bg"></div>
    <nav>
      <div class="nav-left">
        <a href="dashboard.html">
          <img src="../../Data/Images/logo.png" alt="Logo" class="logo" />
        </a>
      </div>
      <div class="nav-right">
        <a href="dashboard.html">Home</a>
        <a href="profile.html">Profile</a>
        <a href="#" onclick="signOut()">Sign Out</a>
      </div>
    </nav>
    <div class="event-wrapper">
      <div class="event-image">
        <img id="eventPoster" src="" alt="Event Poster" />
      </div>
      <div class="event-info">
        <div class="glass-card">
          <div class="title" id="eventTitle">Loading...</div>
          <p class="meta"><b>Club:</b> <span id="eventClub"></span></p>
          <p class="meta"><b>Venue:</b> <span id="eventVenue"></span></p>
          <p class="meta">
            <b>Event Date:</b> <span id="eventDateTime"></span>
          </p>
          <p class="meta">
            <b>Reg Deadline:</b> <span id="eventDeadline"></span>
          </p>
          <div id="eventTags" class="tags-container"></div>
          <div class="desc-box">
            <p id="eventDesc">Loading description...</p>
          </div>
          <button id="actionBtn" class="register-btn" onclick="openPopup()">
            <span id="actionBtnText">Register</span>
          </button>
        </div>
      </div>
    </div>
    <div id="popup" class="popup">
      <div class="popup-card">
        <h2 id="popupTitle">Confirm Registration</h2>
        <p id="popupMessage">
          Are you sure you want to register for this event?
        </p>
        <div class="popup-buttons">
          <button class="popup-btn yes" onclick="handleAction()">Yes</button>
          <button class="popup-btn no" onclick="closePopup()">Cancel</button>
        </div>
      </div>
    </div>
    <div id="alert-popup" class="popup">
      <div class="popup-card">
        <h2 id="alertTitle">Registration Confirmed</h2>
        <p id="alertMessage">Your Registration was completed successfully.</p>
        <div class="popup-buttons">
          <button class="popup-btn yes" onclick="closeAlertPopup()">OK</button>
        </div>
      </div>
    </div>
    <script>
      const BASE_URL = `${window.API_BASE_URL}`;
      const token = localStorage.getItem("auth_token");
      const eventId = new URLSearchParams(window.location.search).get("id");
      let isRegistered = false;
      if (!eventId) {
        alert("Invalid event link");
        window.location.href = "dashboard.html";
      }
      async function loadEventDetails() {
        try {
          const res = await apiFetch(`/events/${eventId}`);
          const ev = await res.json();
          document.getElementById("eventTitle").textContent = ev.title;
          document.getElementById("eventClub").textContent = ev.club;
          document.getElementById("eventVenue").textContent =
            ev.venue || "Not provided";
          if (ev.eventDateTime) {
            const dt = new Date(ev.eventDateTime);
            document.getElementById("eventDateTime").textContent =
              dt.toLocaleString("en-US", {
                dateStyle: "medium",
                timeStyle: "short",
              });
          } else {
            document.getElementById("eventDateTime").textContent =
              "See Description";
          }
          document.getElementById("eventDeadline").textContent = new Date(
            ev.deadline
          ).toDateString();
          document.getElementById("eventDesc").textContent = ev.description;
          const finalPosterUrl =
            ev.posterUrl || "https://placehold.co/800x1200";
          document.getElementById("eventPoster").src = finalPosterUrl;
          const eventImageContainer = document.querySelector(".event-image");
          eventImageContainer.style.setProperty(
            "--bg-image-url",
            `url('${finalPosterUrl}')`
          );
          const tagsContainer = document.getElementById("eventTags");
          if (tagsContainer) {
            let tagHTML = (ev.tags || [])
              .map((t) => `<span class="tag">${t}</span>`)
              .join("");
            tagsContainer.innerHTML = tagHTML;
          }
          if (token) {
            await checkStatus();
          }
        } catch (e) {
          console.error("Error loading details:", e);
        } finally {
          if (window.hideCustomLoader) {
            window.hideCustomLoader();
          }
        }
      }
      async function checkStatus() {
        if (!token) {
          console.log("No token found, skipping status check.");
          return;
        }
        try {
          console.log(`Checking status for Event ID: ${eventId}...`);
          const res = await apiFetch(`/events/${eventId}/status`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });
          if (res.ok) {
            const data = await res.json();
            console.log("Server Data:", data);
            isRegistered = data.isRegistered;
            updateUI();
          } else {
            if (res.status === 401 || res.status === 403) {
              console.warn("Token expired or invalid. Please re-login.");
              window.location.href = "../../index.html";
            } else {
              console.error("Failed to fetch status:", res.statusText);
            }
          }
        } catch (err) {
          console.error("Network error during status check:", err);
        }
      }
      function updateUI() {
        const btn = document.getElementById("actionBtn");
        const txt = document.getElementById("actionBtnText");
        if (isRegistered) {
          txt.textContent = "Unregister";
          btn.classList.add("unregister");
        } else {
          txt.textContent = "Register";
          btn.classList.remove("unregister");
        }
      }
      function openPopup() {
        if (!token) {
          alert("You must be logged in!");
          return;
        }
        const title = document.getElementById("popupTitle");
        const msg = document.getElementById("popupMessage");
        if (isRegistered) {
          title.textContent = "Cancel Registration?";
          msg.textContent =
            "Are you sure you want to unregister? You will receive a cancellation email.";
        } else {
          title.textContent = "Confirm Registration";
          msg.textContent = "Are you sure you want to register for this event?";
        }
        document.getElementById("popup").style.display = "flex";
      }
      function closePopup() {
        document.getElementById("popup").style.display = "none";
      }
      function openAlertPopup(title, message) {
        document.getElementById("alertTitle").textContent = title;
        document.getElementById("alertMessage").textContent = message;
        document.getElementById("alert-popup").style.display = "flex";
      }
      function closeAlertPopup() {
        document.getElementById("alert-popup").style.display = "none";
      }
      async function handleAction() {
        closePopup();
        const wasRegistered = isRegistered;
        console.log("---- ACTION START ----");
        console.log("wasRegistered:", wasRegistered);
        try {
          const endpoint = wasRegistered ? "unregister" : "register";
          const method = wasRegistered ? "DELETE" : "POST";
          console.log(
            "Calling:",
            `/events/${eventId}/${endpoint}`,
            "Method:",
            method
          );
          const res = await apiFetch(`/events/${eventId}/${endpoint}`, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });
          console.log("Response status:", res.status);
          console.log("res.ok:", res.ok);
          const rawText = await res.text();
          console.log("Raw response text:", rawText);
          let data;
          try {
            data = JSON.parse(rawText);
            console.log("Parsed JSON:", data);
          } catch (e) {
            console.warn("JSON parse failed:", e);
            data = {
              msg: wasRegistered
                ? "Unregistered successfully!"
                : "Registered successfully!",
            };
          }
          if (res.ok) {
            console.log("Action SUCCESS, updating UI...");
            openAlertPopup("Success!", data.msg);
            isRegistered = !wasRegistered;
            updateUI();
          } else {
            console.log("Action FAILED:", data.msg);
            openAlertPopup(
              "Action Failed",
              data.msg || "Something went wrong."
            );
          }
        } catch (err) {
          console.error("NETWORK ERROR:", err);
          openAlertPopup("Error", "Network error. Please try again.");
        }
        console.log("---- ACTION END ----");
      }
      loadEventDetails();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
    <script>
      let vantaEffect = VANTA.FOG({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.0,
        minWidth: 200.0,
        highlightColor: 0x0,
        midtoneColor: 0xc5ff,
        lowlightColor: 0x9400ff,
        baseColor: 0x0,
        speed: 1.0,
        zoom: 0.7,
      });
      window.addEventListener("resize", () => {
        if (vantaEffect) vantaEffect.resize();
      });
    </script>
    <script>
      function signOut() {
        localStorage.removeItem("auth_token");
        localStorage.clear();
        window.location.href = "../../index.html";
      }
    </script>
  </body>
</html>
